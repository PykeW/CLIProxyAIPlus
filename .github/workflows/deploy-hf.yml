name: Sync to Hugging Face Hub

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Push to hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          # 格式: 你的HF用户名/你的Space名字
          # 建议在 Secrets 中设置 HF_SPACE_NAME，或者直接在这里修改
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
        run: |
          if [ -z "$HF_SPACE_NAME" ]; then
            echo "Error: HF_SPACE_NAME secret is not set."
            echo "Please set HF_SPACE_NAME in GitHub Secrets (e.g., 'username/space-name')."
            exit 1
          fi

          # 准备 Hugging Face 专用文件
          # 1. 把 Dockerfile.hf 重命名为 Dockerfile (HF 只识别 Dockerfile)
          mv Dockerfile.hf Dockerfile

          # 2. 删除不需要的二进制文件 (HF 禁止直接上传二进制文件)
          rm -f asset/ad/chinese.png asset/ad/english.png

          # 3. 提交这个变更 (只在临时同步分支中生效，不影响原仓库)
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          # 添加 Dockerfile
          git add Dockerfile

          # 移除二进制文件记录 (如果它们之前被跟踪过)
          git rm --cached asset/ad/chinese.png asset/ad/english.png || true

          git commit -m "Prepare for HF deployment" || echo "No changes to commit"

          echo "Pushing to Hugging Face Space: $HF_SPACE_NAME"
          git push https://oauth2:$HF_TOKEN@huggingface.co/spaces/$HF_SPACE_NAME HEAD:main --force
