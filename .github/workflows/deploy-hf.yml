name: Sync to Hugging Face Hub

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  sync-to-hub:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Push to hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          # 格式: 你的HF用户名/你的Space名字
          # 建议在 Secrets 中设置 HF_SPACE_NAME，或者直接在这里修改
          HF_SPACE_NAME: ${{ secrets.HF_SPACE_NAME }}
        run: |
          if [ -z "$HF_SPACE_NAME" ]; then
            echo "Error: HF_SPACE_NAME secret is not set."
            echo "Please set HF_SPACE_NAME in GitHub Secrets (e.g., 'username/space-name')."
            exit 1
          fi

          # -------------------------------------------------------------------------
          # 彻底重构推送逻辑：重建 Git 仓库以清除所有历史和大文件
          # -------------------------------------------------------------------------

          # 1. 准备文件
          mv Dockerfile.hf Dockerfile
          # 删除不需要的目录和文件
          rm -rf asset/ad .git

          # 2. 初始化全新的 Git 仓库
          git init
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          # 3. 添加所有文件 (此时已经没有大文件了)
          git add .
          git commit -m "Deploy to Hugging Face"

          # 4. 强制推送 (覆盖 HF 上的所有内容)
          echo "Pushing to Hugging Face Space: $HF_SPACE_NAME"
          git push https://oauth2:$HF_TOKEN@huggingface.co/spaces/$HF_SPACE_NAME master:main --force
